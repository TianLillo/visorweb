<!DOCTYPE html>
<html>
<head>
    <title>Aixecaments topogràfics AMB</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />
    <link href="css/styles2.css" rel="stylesheet">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidGlhbmxpbGxvIiwiYSI6ImNsY3ludnBmODBhY2Izcm5vYzRibzd3YXoifQ.gOZiyMs0U6_TPz_qK1nvIw';
        var map;
        var aixecamentsLayer;

        function initialize() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/tianlillo/clskq3n7o009201qwakqj8vg2',
                center: [2.16859, 41.3954],
                zoom: 10,
                maxZoom: 20,
                attributionControl: false,
                hash: true
            });

            // Agregar capa de aixecaments desde el archivo geojson
            map.on('load', function () {
                map.addSource('aixecaments', {
                    type: 'geojson',
                    data: 'datos/aixecaments.geojson'
                });

                aixecamentsLayer = {
                    'id': 'aixecaments-layer',
                    'type': 'fill',
                    'source': 'aixecaments',
                    'layout': {},
                    'paint': {
                        'fill-color': '#088',
                        'fill-opacity': 0.8
                    }
                };

                map.addLayer(aixecamentsLayer);

                // Contar elementos al iniciar
                contarElementosGeoJSON();
            });
        }

        function filtrarAixecaments() {
            var mandat = document.getElementById('mandat-filter').value;
            var fet = document.getElementById('fet-filter').value;
            var filters = ['all'];

            if (mandat !== '') {
                filters.push(['==', 'mandat', mandat]);
            }

            if (fet !== '') {
                filters.push(['==', 'fet', fet]);
            }

            map.setFilter('aixecaments-layer', filters);
        }

        function aplicarFiltros() {
            filtrarAixecaments();
        }

        function contarElementosGeoJSON() {
            fetch('datos/aixecaments.geojson')
                .then(response => response.json())
                .then(data => {
                    var count = data.features.length;
                    var resultadoElement = document.getElementById('resultado');
                    resultadoElement.textContent = "Existe un total de " + count + " levantamientos";
                })
                .catch(error => console.error('Error al contar elementos:', error));
        }

        function descargarPoligonosFiltrados() {
    // Obtener los filtros actuales
    var mandat = document.getElementById('mandat-filter').value;
    var fet = document.getElementById('fet-filter').value;
    
    // Construir los filtros basados en las selecciones actuales
    var filters = ['all'];
    if (mandat !== '') {
        filters.push(['==', 'mandat', mandat]);
    }
    if (fet !== '') {
        filters.push(['==', 'fet', fet]);
    }

    // Aplicar los filtros a la capa actual
    map.setFilter('aixecaments-layer', filters);

                            // Obtener solo los polígonos filtrados
                            fetch('datos/aixecaments.geojson')
                                .then(response => response.json())
                                .then(data => {
                                    // Filtrar solo los polígonos que coinciden con los filtros actuales
                                    const filteredFeatures = data.features.filter(feature => {
                                        let properties = feature.properties;
                                        return (properties.mandat === mandat || mandat === '') &&
                                            (properties.fet === fet || fet === '');
                                    });

                                    // Convertir los polígonos filtrados en formato de texto
                                    const featuresText = filteredFeatures.map(feature => {
                                        const properties = feature.properties;
                                        return `${properties.OBJECTID}, ${properties.nom_aixeca}, ${properties.municipi}`;
                                    }).join('\n');

                                    // Crear un Blob y descargar el archivo de texto
                                    const blob = new Blob([featuresText], { type: 'text/plain' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = 'poligonos_filtrados.txt';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                })
                                .catch(error => console.error('Error al descargar polígonos filtrados:', error));
                        }



        window.onload = initialize;
    </script>
</head>
<body>
<div class="header">
    <p><img src="imagen/logo.png"/></p>
    <h1>Aixecaments topogràfics de l'AMB</h1>
</div>
<div class="menu">
    <ul>
        <li><a>Mandat</a>
            <select id="mandat-filter">
                <option value="">Tots</option>
                <option value="2008-2011">2008-2011</option>
                <option value="2012-2015">2012-2015</option>
                <option value="2016-2019">2016-2019</option>
                <option value="2020-2023">2020-2023</option>
                <option value="2024-2027">2024-2027</option>
            </select>
        </li>
        <li><a>Fet</a>
            <select id="fet-filter">
                <option value="">Tots</option>
                <option value="Intern">Intern</option>
                <option value="Extern">Extern</option>
                <option value="S/I">S/I</option>
            </select>
        </li>
        <li><button onclick="aplicarFiltros()">¡Filtra!</button></li>
    </ul>
</div>

<div class="wrapper">
    <div id="map" style="width: 100%; height: 600px;"></div>
</div>
<div class="bottom">
    <div id="resultado"></div>
        <button onclick="descargarPoligonosFiltrados()">Descargar Polígonos Filtrados</button>

</div>
</body>
</html>
