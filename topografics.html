<!DOCTYPE html>
<html>
  <head>
    <title>Aixecaments topogràfics AMB</title>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css"
      rel="stylesheet"
    />

    <link href="css/styles2.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
      type="text/css"
    />

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoidGlhbmxpbGxvIiwiYSI6ImNsY3ludnBmODBhY2Izcm5vYzRibzd3YXoifQ.gOZiyMs0U6_TPz_qK1nvIw";
      var map;
      var aixecamentsLayer;
      var selectedPolygonId = null;
      var marker = null; // Variable para almacenar la referencia al marcador
      let contador_ini = 0;
      let contador_filtro = 0;

      function initialize() {
        map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/tianlillo/clskq3n7o009201qwakqj8vg2",
          center: [2.1, 41.4],
          zoom: 10.5,
          maxZoom: 20,
          attributionControl: false,
          hash: true,
        });
        map.addControl(
          new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
          })
        );
        map.addControl(
          new mapboxgl.AttributionControl({
            compact: true,
          })
        );
        map.addControl(new mapboxgl.NavigationControl());

        // Agregar capa de aixecaments desde el archivo geojson
        map.on("load", function () {
          map.addSource("aixecaments", {
            type: "geojson",
            data: "datos/aixecaments.geojson",
          });

          aixecamentsLayer = {
            id: "aixecaments-layer",
            type: "fill",
            source: "aixecaments",
            layout: {},
            paint: {
              "fill-color": [
                "case",
                ["==", ["get", "as_built"], "si"], // Si la propiedad "as_built" es igual a "si"
                "#FF0000", // Color rojo si es verdadero
                "#C845C8", // Color predeterminado si es falso
              ],
              "fill-opacity": 0.5,
              "fill-outline-color": "#000",
            },
          };
          // Añadir la capa de polígonos 'municipis.geojson'
          map.addSource("municipis-source", {
            type: "geojson",
            data: "datos/municipis.geojson",
          });

          map.addLayer({
            id: "municipis-layer",
            type: "line",
            source: "municipis-source",
            paint: {
              "line-color": "#000",
              "line-width": 1,
            },
          });

          map.addLayer(aixecamentsLayer);
        });
        contarElementos();

        // Definir una variable para almacenar el ID del polígono seleccionado
        var selectedPolygonId = null;

        // Agregar un evento de click al polígono
        map.on("click", "aixecaments-layer", function (e) {
          // Restaurar el estilo del polígono anteriormente seleccionado
          if (selectedPolygonId !== null) {
            map.setFeatureState(
              { source: "aixecaments", id: selectedPolygonId },
              { selected: false }
            );
            map.setPaintProperty("aixecaments-layer", "fill-color", [
              "case",
              ["==", ["id"], selectedPolygonId], // Si es el polígono seleccionado
              "#FF0000", // Restaurar el color original
              "#C845C8",
            ]);
            map.setPaintProperty("aixecaments-layer", "fill-outline-color", [
              "case",
              ["==", ["id"], selectedPolygonId], // Si es el polígono seleccionado
              "#000000", // Restaurar el color original
              "#000000",
            ]);
          }

          // Obtener el ID del polígono seleccionado y resaltarlo
          selectedPolygonId = e.features[0].id;
          map.setFeatureState(
            { source: "aixecaments", id: selectedPolygonId },
            { selected: true }
          );

          // Cambiar el estilo del polígono seleccionado
          map.setPaintProperty("aixecaments-layer", "fill-color", [
            "case",
            ["==", ["id"], selectedPolygonId], // Si es el polígono seleccionado
            "#F6FF30", // Relleno amarillo para el polígono seleccionado
            ["==", ["get", "as_built"], "no"], // Si "as_built" es igual a "no"
            "#C845C8", // Relleno morado para los polígonos con "as_built" igual a "no"
            "#FF0000", // Relleno turquesa para los polígonos con "as_built" igual a "si"
          ]);
          map.setPaintProperty("aixecaments-layer", "fill-outline-color", [
            "case",
            ["==", ["id"], selectedPolygonId], // Si es el polígono seleccionado
            "#16F4E7", // Contorno turquesa para el polígono seleccionado
            "#000000", // Contorno negro para los demás polígonos
          ]);

          //Agregar popUp cuando se clickea
          var features = e.features[0];
          var popupContent =
            "<h3>" +
            features.properties.nom_aixeca +
            "</h3>" +
            "<p>Data: " +
            new Date(features.properties.fecha).toLocaleDateString() +
            "</p>" +
            "<p>Mandat: " +
            features.properties.mandat +
            "</p>" +
            "<p>Fet: " +
            features.properties.fet +
            "</p>" +
            "<p>Municipi: " +
            features.properties.municipi +
            "</p>" +
            "<p>Tecnologia: " +
            features.properties.tecnologia +
            "</p>";

          var popup = new mapboxgl.Popup({
            offset: [20, -50],
            anchor: "bottom-left",
          })
            .setLngLat(e.lngLat)
            .setHTML(popupContent)
            .addTo(map);

          // Evento para restaurar el estilo del polígono cuando se cierra el popup
          popup.on("close", function () {
            // Restaurar el estilo del polígono
            map.setFeatureState(
              { source: "aixecaments", id: selectedPolygonId },
              { selected: false }
            );
            map.setPaintProperty("aixecaments-layer", "fill-color", [
              "case",
              ["==", ["get", "as_built"], "si"], // Si la propiedad "as_built" es igual a "si"
              "#FF0000", // Color rojo si es verdadero
              "#C845C8", // Color predeterminado si es falso
            ]);
            map.setPaintProperty(
              "aixecaments-layer",
              "fill-outline-color",
              "#000"
            );
            selectedPolygonId = null; // Restablecer el ID del polígono seleccionado a null
          });
        });

        // Cambia el cursor al pasar sobre los polígonos
        map.on("mouseenter", "aixecaments-layer", function () {
          map.getCanvas().style.cursor = "pointer";
        });

        // Cambia el cursor al salir de los polígonos
        map.on("mouseleave", "aixecaments-layer", function () {
          map.getCanvas().style.cursor = "";
        });
      }

      function filtrarAixecaments() {
        var mandat = document.getElementById("mandat-filter").value;
        var fet = document.getElementById("fet-filter").value;
        var tecnologia = document.getElementById("tecnologia-filter").value;
        var as_built = document.getElementById("as-built-filter").value;
        var municipi = document.getElementById("municipi-filter").value;
        var filters = ["all"];

        var features = map.querySourceFeatures("aixecaments-layer");

        if (mandat !== "") {
          filters.push(["==", "mandat", mandat]);
        }

        if (fet !== "") {
          filters.push(["==", "fet", fet]);
        }

        if (tecnologia !== "") {
          filters.push(["==", "tecnologia", tecnologia]);
        }

        if (as_built !== "") {
          filters.push(["==", "as_built", as_built]);
        }

        if (municipi !== "") {
          filters.push(["==", "municipi", municipi]);
        }

        map.setFilter("aixecaments-layer", filters);

        var filtersLength = filters.length;
        console.log("Longitud del array de filtros:", filtersLength);
      }

      function aplicarFiltros() {
        filtrarAixecaments();
      }

      function contarElementos() {
        fetch("datos/aixecaments.geojson")
          .then((response) => response.json())
          .then((data) => {
            // Verificar si el archivo contiene la propiedad 'features'
            if (data && data.features && Array.isArray(data.features)) {
              // Contar la cantidad de características
              contador_ini = data.features.length;
              console.log("Cantidad de elementos:", contador_ini);
            } else {
              console.error("El archivo no tiene un formato válido.");
            }
          })
          .catch((error) => {
            console.error("Error al cargar el archivo:", error);
          });
      }

      function descargarPoligonosFiltrados() {
        // Obtener los filtros actuales
        var mandat = document.getElementById("mandat-filter").value;
        var fet = document.getElementById("fet-filter").value;
        var tecnologia = document.getElementById("tecnologia-filter").value;
        var as_built = document.getElementById("as-built-filter").value;
        var municipi = document.getElementById("municipi-filter").value;

        // Construir los filtros basados en las selecciones actuales
        var filters = ["all"];
        if (mandat !== "") {
          filters.push(["==", "mandat", mandat]);
        }
        if (fet !== "") {
          filters.push(["==", "fet", fet]);
        }
        if (tecnologia !== "") {
          filters.push(["==", "tecnologia", tecnologia]);
        }
        if (as_built !== "") {
          filters.push(["==", "as_built", as_built]);
        }
        if (municipi !== "") {
          filters.push(["==", "municipi", municipi]);
        }

        // Obtener solo los polígonos filtrados
        fetch("datos/aixecaments.geojson")
          .then((response) => response.json())
          .then((data) => {
            // Filtrar solo los polígonos que coinciden con los filtros actuales
            const filteredFeatures = data.features.filter((feature) => {
              let properties = feature.properties;
              return (
                (properties.mandat === mandat || mandat === "") &&
                (properties.fet === fet || fet === "") &&
                (properties.tecnologia === tecnologia || tecnologia === "") &&
                (properties.as_built === as_built || as_built === "") &&
                (properties.municipi === municipi || municipi === "")
              );
            });

            // Convertir los polígonos filtrados en formato de texto
            const featuresText = filteredFeatures
              .map((feature) => {
                const properties = feature.properties;
                return `${properties.OBJECTID}, ${properties.nom_aixeca}, ${properties.municipi}`;
              })
              .join("\n");

            // Crear un Blob y descargar el archivo de texto
            const blob = new Blob([featuresText], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "poligonos_filtrados.txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          })
          .catch((error) =>
            console.error("Error al descargar polígonos filtrados:", error)
          );
      }

      window.onload = initialize;
    </script>
  </head>
  <body>
    <div class="header">
      <p><img src="imagen/logo.png" /></p>
      <h1>Aixecaments topogràfics de l'AMB</h1>
      <h2>Departament de topografia</h2>
    </div>
    <div class="menu">
      <ul>
        <li>
          <a>Mandat</a>
          <select id="mandat-filter">
            <option value="">Tots</option>
            <option value="2008-2011">2008-2011</option>
            <option value="2012-2015">2012-2015</option>
            <option value="2016-2019">2016-2019</option>
            <option value="2020-2023">2020-2023</option>
            <option value="2024-2027">2024-2027</option>
          </select>
        </li>
        <li>
          <a>Fet</a>
          <select id="fet-filter">
            <option value="">Tots</option>
            <option value="Intern">Intern</option>
            <option value="Extern">Extern</option>
            <option value="S/I">S/I</option>
          </select>
        </li>
        <li>
          <a>Tecnologia</a>
          <select id="tecnologia-filter">
            <option value="">Tots</option>
            <option value="ET/GPS">ET y GPS</option>
            <option value="GPS">GPS</option>
            <option value="LS">Laser scanner</option>
            <option value="NIVELL">Nivell</option>
          </select>
        </li>
        <li>
          <a>As Built</a>
          <select id="as-built-filter">
            <option value="">Tots</option>
            <option value="si">Si</option>
            <option value="no">No</option>
          </select>
        </li>
        <li>
          <a>Municipi</a>
          <select id="municipi-filter">
            <option value="">Tots</option>
            <option value="Badalona">Badalona</option>
            <option value="Badia del Vallès">Badia del Vallès</option>
            <option value="Barberà del Vallès">Barberà del Vallès</option>
            <option value="Barcelona">Barcelona</option>
            <option value="Begues">Begues</option>
            <option value="Castellbisbal">Castellbisbal</option>
            <option value="Castelldefels">Castelldefels</option>
            <option value="Cerdanyola del Vallès">Cerdanyola del Vallès</option>
            <option value="Cervelló">Cervelló</option>
            <option value="Corbera de Llobregat">Corbera de Llobregat</option>
            <option value="Cornellà de Llobregat">Cornellà de Llobregat</option>
            <option value="El Masnou">El Masnou</option>
            <option value="El Papiol">El Papiol</option>
            <option value="El Prat de Llobregat">El Prat de Llobregat</option>
            <option value="Esplugues de Llobregat">
              Esplugues de Llobregat
            </option>
            <option value="Gavà">Gavà</option>
            <option value="L'Hospitalet de Llobregat">
              L'Hospitalet de Llobregat
            </option>
            <option value="La Palma de Cervelló">La Palma de Cervelló</option>
            <option value="Molins de Rei">Molins de Rei</option>
            <option value="Montcada i Reixac">Montcada i Reixac</option>
            <option value="Montgat">Montgat</option>
            <option value="Pallejà">Pallejà</option>
            <option value="Ripollet">Ripollet</option>
            <option value="Sant Adrià de Besòs">Sant Adrià de Besòs</option>
            <option value="Sant Andreu de la Barca">
              Sant Andreu de la Barca
            </option>
            <option value="Sant Boi de Llobregat">Sant Boi de Llobregat</option>
            <option value="Sant Climent de Llobregat">
              Sant Climent de Llobregat
            </option>
            <option value="Sant Cugat del Vallès">Sant Cugat del Vallès</option>
            <option value="Sant Feliu de Llobregat">
              Sant Feliu de Llobregat
            </option>
            <option value="Sant Joan Despí">Sant Joan Despí</option>
            <option value="Sant Just Desvern">Sant Just Desvern</option>
            <option value="Sant Vicenç dels Horts">
              Sant Vicenç dels Horts
            </option>
            <option value="Santa Coloma de Cervelló">
              Santa Coloma de Cervelló
            </option>
            <option value="Santa Coloma de Gramenet">
              Santa Coloma de Gramenet
            </option>
            <option value="Tiana">Tiana</option>
            <option value="Torrelles de Llobregat">
              Torrelles de Llobregat
            </option>
            <option value="Viladecans">Viladecans</option>
          </select>
        </li>
        <li>
          <button class="filtro-btn" onclick="aplicarFiltros()">Filtra</button>
        </li>
      </ul>
    </div>

    <div class="wrapper">
      <div id="map" style="width: 100%; height: 780px"></div>
    </div>
    <div class="bottom">
      <p>
        <button onclick="descargarPoligonosFiltrados()">
          Descargar Polígonos Filtrados
        </button>
      </p>
    </div>
  </body>
</html>
